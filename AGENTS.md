# AGENTS.md — ArticleVoice

## Project Overview

ArticleVoice is a Progressive Web App that converts article URLs into spoken audio using the browser's Web Speech API. It uses a CORS proxy (Cloudflare Worker) to fetch articles, Mozilla Readability.js to extract content, and the SpeechSynthesis API for text-to-speech.

## Memory & Continuous Learning

This project maintains a persistent learning system across AI agent sessions.

### Required Workflow

1. **Start of task:** Read `LESSONS_LEARNED.md` before writing any code
2. **During work:** Note any surprises, gotchas, or non-obvious discoveries
3. **End of iteration:** Append to `ITERATION_LOG.md` with what happened
4. **End of iteration:** If the insight is reusable and validated, also add to `LESSONS_LEARNED.md`
5. **Pattern detection:** If the same issue appears 2+ times in the log, promote it to a lesson

### Files

| File | Purpose | When to Write |
|------|---------|---------------|
| `LESSONS_LEARNED.md` | Curated, validated, reusable wisdom | End of iteration (if insight is reusable) |
| `ITERATION_LOG.md` | Raw session journal, append-only | End of every iteration (always) |

### Rules

- Never delete entries from `ITERATION_LOG.md` — it's append-only
- In `LESSONS_LEARNED.md`, obsolete lessons go to the Archive section, not deleted
- Keep entries concise — a future agent scanning 100 entries needs signal, not prose
- Date-stamp everything in `YYYY-MM-DD` format
- When in doubt about whether something is worth logging: log it

## Tech Stack

- **Language:** TypeScript (strict mode), compiled to ES2020 modules
- **Runtime:** Browser only — no Node.js server, no framework
- **Build:** `tsc` only — no bundler. Run `npm run build` to compile
- **Testing:** Vitest with jsdom environment. Run `npm test`
- **Hosting target:** GitHub Pages (static files)
- **CI/CD:** GitHub Actions — auto-deploys Pages on push, auto-deploys CF Worker on `worker/` changes

## Codemaps

Detailed architecture diagrams and module references live in `doc/codemaps/`:

- **[Architecture Overview](doc/codemaps/architecture.md)** — data flow, dependency graph, deployment targets
- **[Module Reference](doc/codemaps/modules.md)** — every module's API, functions, and key design notes

## Repository Layout

```
src/                     # TypeScript source (edit these)
  app.ts                 # Main orchestrator — UI wiring, settings, flow control
  lib/
    url-utils.ts         # URL validation, Share Target query param parsing
    lang-detect.ts       # EN/RO language detection (heuristic)
    extractor.ts         # Fetch via CORS proxy + Readability.js parsing
    tts-engine.ts        # Web Speech API wrapper with sentence chunking

src/__tests__/           # Vitest test files
  url-utils.test.ts
  lang-detect.test.ts
  extractor.test.ts
  tts-engine.test.ts

app.js, lib/*.js         # Compiled output (do NOT edit — generated by tsc)
index.html               # App shell (single page)
style.css                # Dark-theme mobile-first styles
manifest.json            # PWA manifest with Share Target config
sw.js                    # Service Worker (plain JS, not compiled from TS)
vendor/Readability.js    # Vendored Mozilla Readability (~2800 lines)
worker/
  cors-proxy.js          # Cloudflare Worker CORS proxy
  wrangler.toml          # Wrangler deployment config
.github/workflows/
  deploy-pages.yml       # GitHub Pages CI/CD (build + test + deploy)
  deploy-worker.yml      # Cloudflare Worker CI/CD (on worker/ changes)
icons/                   # PWA icons
```

## Build & Test Commands

```sh
npm install              # Install devDependencies (typescript, vitest)
npm run build            # Compile TypeScript: src/**/*.ts → ./*.js
npm test                 # Run Vitest test suite
npm run watch            # Compile TypeScript in watch mode
```

## Key Architecture Rules

1. **No bundler.** The browser loads ES modules directly. All import paths must end in `.js` (TypeScript source uses `.js` extensions in imports and `tsc` preserves them).
2. **Compiled JS goes to root.** `tsconfig.json` has `outDir: "."` and `rootDir: "src"`, so `src/app.ts` compiles to `./app.js` and `src/lib/foo.ts` compiles to `./lib/foo.js`.
3. **Service Worker is plain JS.** `sw.js` is not TypeScript — it runs in a different scope and is kept simple.
4. **Readability.js is a global.** It's loaded via `<script>` tag before `app.js`. In TypeScript, it's accessed via a `declare const Readability` ambient declaration in `extractor.ts`.
5. **The Cloudflare Worker is deployed separately.** `worker/cors-proxy.js` is deployed via GitHub Actions using wrangler. It's configured in `worker/wrangler.toml` and uses environment bindings (`ALLOWED_ORIGIN`, `PROXY_SECRET`) instead of hardcoded constants.

## Critical Implementation Details

### TTS Sentence Chunking (tts-engine.ts)
Chrome on Android silently stops speaking after ~15 seconds of continuous text. The engine splits each paragraph into sentences and speaks one `SpeechSynthesisUtterance` per sentence, chaining them via `onend` callbacks. **Do not combine sentences into a single utterance.**

### Share Target (manifest.json + url-utils.ts)
The PWA uses `method: "GET"` for its share target. Shared URLs arrive as query params (`?url=...`). Some apps put the URL in `?text=` instead — `url-utils.ts` checks both fields.

### CORS Proxy Security (worker/cors-proxy.js)
The proxy rejects private IPs (SSRF prevention), enforces a 2 MB response limit, sets a 10-second timeout, and strips cookies. It validates requests via a shared secret (`X-Proxy-Key` header, checked against the `PROXY_SECRET` env binding). `ALLOWED_ORIGIN` is set to the GitHub Pages domain in `wrangler.toml`.

### CORS Proxy Rate Limiting (worker/cors-proxy.js)
The proxy enforces a rate limit of **20 requests per minute per client IP** using an in-memory sliding window. Each Cloudflare edge PoP maintains its own counters (slightly more permissive than a global limit, but sufficient for abuse prevention).

- **Limit:** 20 requests per 60-second window
- **Scope:** per client IP (from `CF-Connecting-IP` header)
- **HTTP 429** response when exceeded, with `Retry-After` header (seconds)
- **Response headers on all requests:** `X-RateLimit-Limit`, `X-RateLimit-Remaining`
- **Client-side:** `extractor.ts` detects 429 and shows a user-friendly "Rate limit exceeded" message with the retry-after countdown

If you're building a tool or script that calls this proxy, stay under 20 requests/minute or you'll get 429 errors.

### URL Resolution (worker/cors-proxy.js + extractor.ts)
The proxy follows redirects (`redirect: 'follow'`) and returns the final resolved URL in the `X-Final-URL` response header. The extractor reads this header and stores it as `article.resolvedUrl`. This is critical for shortened URLs (e.g. `share.google`) — the translate button uses the resolved URL to construct the Google Translate proxy host. Without it, shortened domains produce invalid translate URLs.

## Configuration

The proxy URL and secret must be set in `src/app.ts`:

```ts
const CONFIG = {
  PROXY_BASE: 'https://article-voice-proxy.fabian20ro.workers.dev',
  PROXY_SECRET: '',  // same value as the PROXY_SECRET worker secret
};
```

After changing, run `npm run build` to recompile.

## CI/CD

Three GitHub repository secrets are required:

| Secret | Purpose |
|--------|---------|
| `CLOUDFLARE_API_TOKEN` | Wrangler uses this to deploy the worker |
| `CLOUDFLARE_ACCOUNT_ID` | Identifies the Cloudflare account |
| `PROXY_SECRET` | Shared secret injected into the worker as an env binding |

See README.md for step-by-step setup instructions.

## Testing Notes

- Tests use Vitest with `jsdom` environment for DOM API access
- `tts-engine.test.ts` mocks `speechSynthesis` and `SpeechSynthesisUtterance` globally
- `extractor.test.ts` mocks `fetch` and the global `Readability` constructor
- Pure-function modules (`url-utils.ts`, `lang-detect.ts`) are tested directly without mocks
