# AGENTS.md — ArticleVoice

## Project Overview

ArticleVoice is a Progressive Web App that converts article URLs into spoken audio using the browser's Web Speech API. It uses a CORS proxy (Cloudflare Worker) to fetch articles, Mozilla Readability.js to extract content, and the SpeechSynthesis API for text-to-speech.

## Tech Stack

- **Language:** TypeScript (strict mode), compiled to ES2020 modules
- **Runtime:** Browser only — no Node.js server, no framework
- **Build:** `tsc` only — no bundler. Run `npm run build` to compile
- **Testing:** Vitest with jsdom environment. Run `npm test`
- **Hosting target:** GitHub Pages (static files)

## Repository Layout

```
src/                     # TypeScript source (edit these)
  app.ts                 # Main orchestrator — UI wiring, settings, flow control
  lib/
    url-utils.ts         # URL validation, Share Target query param parsing
    lang-detect.ts       # EN/RO language detection (heuristic)
    extractor.ts         # Fetch via CORS proxy + Readability.js parsing
    tts-engine.ts        # Web Speech API wrapper with sentence chunking

src/__tests__/           # Vitest test files
  url-utils.test.ts
  lang-detect.test.ts
  extractor.test.ts
  tts-engine.test.ts

app.js, lib/*.js         # Compiled output (do NOT edit — generated by tsc)
index.html               # App shell (single page)
style.css                # Dark-theme mobile-first styles
manifest.json            # PWA manifest with Share Target config
sw.js                    # Service Worker (plain JS, not compiled from TS)
vendor/Readability.js    # Vendored Mozilla Readability (~2800 lines)
worker/cors-proxy.js     # Cloudflare Worker CORS proxy (deploy separately)
icons/                   # PWA icons
```

## Build & Test Commands

```sh
npm install              # Install devDependencies (typescript, vitest)
npm run build            # Compile TypeScript: src/**/*.ts → ./*.js
npm test                 # Run Vitest test suite
npm run watch            # Compile TypeScript in watch mode
```

## Key Architecture Rules

1. **No bundler.** The browser loads ES modules directly. All import paths must end in `.js` (TypeScript source uses `.js` extensions in imports and `tsc` preserves them).
2. **Compiled JS goes to root.** `tsconfig.json` has `outDir: "."` and `rootDir: "src"`, so `src/app.ts` compiles to `./app.js` and `src/lib/foo.ts` compiles to `./lib/foo.js`.
3. **Service Worker is plain JS.** `sw.js` is not TypeScript — it runs in a different scope and is kept simple.
4. **Readability.js is a global.** It's loaded via `<script>` tag before `app.js`. In TypeScript, it's accessed via a `declare const Readability` ambient declaration in `extractor.ts`.
5. **The Cloudflare Worker is deployed separately.** `worker/cors-proxy.js` is not part of the app build — it's pasted into the Cloudflare dashboard.

## Critical Implementation Details

### TTS Sentence Chunking (tts-engine.ts)
Chrome on Android silently stops speaking after ~15 seconds of continuous text. The engine splits each paragraph into sentences and speaks one `SpeechSynthesisUtterance` per sentence, chaining them via `onend` callbacks. **Do not combine sentences into a single utterance.**

### Share Target (manifest.json + url-utils.ts)
The PWA uses `method: "GET"` for its share target. Shared URLs arrive as query params (`?url=...`). Some apps put the URL in `?text=` instead — `url-utils.ts` checks both fields.

### CORS Proxy Security (worker/cors-proxy.js)
The proxy rejects private IPs (SSRF prevention), enforces a 2 MB response limit, sets a 10-second timeout, and strips cookies. The `ALLOWED_ORIGIN` should be restricted to the GitHub Pages domain in production.

## Configuration

The proxy URL must be set in `src/app.ts`:

```ts
const CONFIG = {
  PROXY_BASE: 'https://article-voice-proxy.YOUR_SUBDOMAIN.workers.dev',
};
```

After changing, run `npm run build` to recompile.

## Testing Notes

- Tests use Vitest with `jsdom` environment for DOM API access
- `tts-engine.test.ts` mocks `speechSynthesis` and `SpeechSynthesisUtterance` globally
- `extractor.test.ts` mocks `fetch` and the global `Readability` constructor
- Pure-function modules (`url-utils.ts`, `lang-detect.ts`) are tested directly without mocks
